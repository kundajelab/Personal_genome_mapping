Sofia's alignment code, adapted by Oana Ursu for use on scg3.